# Copyright (C) 2022 Roberto Rossini (roberros@uio.no)
# SPDX-License-Identifier: MIT

name: Release Cryptonite on test.pypi

on:
  release:
    types: [ published ]

jobs:
  publish-package-pipy:
    name: Publish Cryptonite on test.pypi
    runs-on: ubuntu-latest
    steps:
      # Download package generated by the make-package.yml workflow (which was called by ci.yml)
      - name: Download package artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: ci.yml
          workflow_conclusion: success
          name: cryptonite-${{ github.ref_name }}

      - name: Extract package
        run: tar -xf cryptonite-*.tar.xz --strip-components=1

      - name: Generate requirements.txt
        # Twine is one of the packages that can be used to upload packages to PyPI
        run: echo 'twine>=4' > requirements.txt

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache-dependency-path: requirements.txt
          cache: pip

      - name: Install twine
        run: python3 -m pip install -r requirements.txt

      - name: Upload package to test.pypi
        # One way to authenticate to a remote server using twine is to define the
        # TWINE_USERNAME and TWINE_PASSWORD env vars.
        env:
          TWINE_USERNAME: ${{ secrets.TESTPYPI_USERNAME }}
          TWINE_PASSWORD: ${{ secrets.TESTPYPI_PASSWORD }}
        run: python3 -m twine upload --repository testpypi *cryptonite*.{whl,tar.gz}

  download-package:
    name: Download Cryptonite from test.pypi
    needs: publish-package-pipy
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.7", "3.8", "3.9", "3.10", "3.11", "3.12-rc"]
      fail-fast: false

    # Run job inside a docker container.
    # See https://hub.docker.com/_/python for a list of the official Python Docker images
    # This is often faster than using actions/setup-python@v4 and gives us access to more versions
    container: python:${{ matrix.python-version }}

    steps:
      - name: Download Cryptonite from PyPI
        run: |
          sleep 5
          
          python3 -m pip install \
            --extra-index-url https://test.pypi.org/simple/ \
            "2022-sbi-ci-workflow-cryptonite==${{ github.ref_name }}"
          
          # ${{ github.ref_name }} is set to the release tag (e.g. 0.0.1) when workflow
          # is triggered by a release event

      - name: Check Cryptonite version
        run: cryptonite --version


  make-package-for-gh-release:
    name: Prepare package for GitHub release
    runs-on: ubuntu-latest

    steps:
      - name: Download package artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: ci.yml
          workflow_conclusion: success
          name: cryptonite-${{ github.ref_name }}

      - name: Prepare release archive
        run: |
          tar -xf "cryptonite-${{ github.ref_name }}.tar.xz"
          
          # Remove unneded files
          rm "cryptonite-${{ github.ref_name }}/pyproject.toml"
          
          # Checksum files
          (cd "cryptonite-${{ github.ref_name }}" && shasum -a256 * > checksums.sha256)
          
          # Archive checksummed files.
          # Files from this archive can be attached to a GitHub release.
          tar -cJf "cryptonite-${{ github.ref_name }}.tar.xz" "cryptonite-${{ github.ref_name }}/"

      - name: Upload release artifact
        uses: actions/upload-artifact@v3
        with:
          name: cryptonite-${{ github.ref_name }}-release
          path: cryptonite-${{ github.ref_name }}.tar.xz
          if-no-files-found: error
          retention-days: 90  # Retain release artifacts for 3 months.
                              # It is not possible to generate artifacts that never
                              # expire, but we could write a workflow that runs on a schedule
                              # to refresh artifacts that are about to expire.
